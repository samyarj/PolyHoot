<div class="poll-page-container">
    <div class="poll-page-content">
        <div class="container">
            <div class="forms-container">
                <form class="row mt-2 poll-info" #pollForm="ngForm" @pollFormAnimation>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="title">Titre du sondage:</label>
                            <input
                                type="text"
                                class="form-control"
                                id="title"
                                [(ngModel)]="poll.title"
                                placeholder="Entrez le titre du sondage"
                                name="title"
                                required
                                maxlength="30"
                                #title="ngModel"
                            />
                            <small class="text-danger" *ngIf="isPollTitleEmpty()"> Il faut un titre.</small>
                            <small class="text-danger" *ngIf="title.errors?.['maxlength']">
                                Le titre ne devrait pas avoir plus de 30 caractères.
                            </small>
                        </div>
                        <div class="form-group" id="description">
                            <label for="description-input">Description du sondage:</label>
                            <input
                                type="text"
                                class="form-control"
                                id="description-input"
                                [(ngModel)]="poll.description"
                                name="description"
                                maxlength="200"
                                #descriptionModel="ngModel"
                                required
                            />
                            <small class="text-danger">
                                <ng-container *ngIf="isDescriptionEmpty()"> Il faut une description.</ng-container>
                                <ng-container *ngIf="descriptionModel.errors?.maxlength">
                                    La description ne devrait pas avoir plus de 200 caractères.
                                </ng-container>
                            </small>
                        </div>
                    </div>
                </form>

                <form class="form-question-container" #questionForm="ngForm" (ngSubmit)="addQuestion()">
                    <div class="question-info-section">
                        <div class="form-group question-text">
                            <label class="form-label" for="question-text-id">Question</label>
                            <input
                                class="form-control"
                                id="question-text-id"
                                type="text"
                                [(ngModel)]="question.text"
                                placeholder="Entrez votre question."
                                name="text"
                                #text="ngModel"
                                required
                            />
                            <small class="text-danger" *ngIf="isQuestionTextEmpty()">Entrez votre question</small>
                        </div>
                    </div>

                    <div class="form-group answers-section">
                        <label class="form-label">Réponses:</label>
                        <div cdkDropList class="answers-list" (cdkDropListDropped)="drop($event)">
                            <div *ngFor="let choice of question.choices; let i = index" class="mb-2 question-choice" cdkDrag>
                                <div class="input-group">
                                    <p>{{ i + 1 }}.</p>
                                    <input
                                        type="text"
                                        class="form-control"
                                        [(ngModel)]="choice.text"
                                        placeholder="Entrez le contenu de la réponse"
                                        name="answer{{ choice.text }}"
                                        required
                                        #answer="ngModel"
                                    />
                                    <div class="button-section">
                                        <button
                                            class="btn btn-dark btn-sm"
                                            type="button"
                                            *ngIf="question.choices && question.choices.length > 2"
                                            (click)="deleteAnswer(i)"
                                            matTooltip="Supprimer"
                                        >
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        <i class="fas fa-grip-vertical"></i>
                                    </div>
                                </div>
                                <small class="form-text text-danger" *ngIf="answer.invalid && (answer.dirty || answer.touched)">
                                    La réponse est requise
                                </small>
                            </div>
                        </div>
                        <button
                            class="btn btn-secondary btn-sm"
                            type="button"
                            *ngIf="question.choices && question.choices.length < 4"
                            (click)="addAnswer()"
                        >
                            <i matTooltip="Ajouter un choix de réponse" class="fa-solid fa-plus"></i>
                        </button>
                        <div *ngIf="!validUniqueChoiceTexts()" class="text-danger">*Les choix de réponse doivent être uniques</div>
                        <div *ngIf="!questionForm.valid || !areQuestionChoicesTextValid()" class="text-danger">*Tous les champs sont requis.</div>
                    </div>
                    <div class="submit-section">
                        <button *ngIf="showButton" type="button" class="custom-button-cancel-medium" (click)="resetAnswers()">Tout effacer</button>
                        <button *ngIf="showButton" type="submit" class="custom-button-medium" [disabled]="!questionForm.valid || !validQuestion()">
                            {{ submitQuestionButton }}
                        </button>
                    </div>
                </form>
            </div>
            <div class="created-question-container" @pollFormAnimation>
                <h2>Questions</h2>
                <ul class="question-list-container" cdkDropList (cdkDropListDropped)="onDrop($event)">
                    <li
                        *ngFor="let question of poll.questions; trackBy: trackByFn; let i = index"
                        @zoomIn
                        @bounceOut
                        class="question-item"
                        cdkDrag
                        cdkDragPreviewClass="drag-preview"
                    >
                        <div class="question-title truncate-text">{{ i + 1 }}. {{ question.text }}</div>
                        <span class="action-icons">
                            <i class="fas fa-pencil-alt" (click)="editQuestion(i)" matTooltip="Modifier"></i>
                            <i class="fas fa-trash-alt" (click)="deleteQuestion(i)" matTooltip="Supprimer"></i>
                        </span>
                    </li>
                </ul>
                <div *ngIf="poll.questions.length > 0" class="custom-button-medium add-question-icon">
                    <i class="fas fa-plus-circle" (click)="addQuestion()"></i>
                </div>
            </div>
        </div>
        <div class="submit-poll-section">
            <button (click)="emptyPollAndRedirect()" class="custom-button-cancel-medium">Annuler</button>
            <button
                class="custom-button-medium"
                [ngClass]="{ 'custom-button-disabled-medium': !pollForm.valid || !validatePoll() }"
                [disabled]="!pollForm.valid || !validatePoll()"
                (click)="submitPollEvent()"
            >
                {{ submitPollButton }}
            </button>
        </div>
    </div>
</div>
