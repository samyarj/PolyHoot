<div class="container">
    <div class="forms-container">
        <form class="row mt-2 game-info" #gameForm="ngForm" @gameFormAnimation>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="title">Titre du sondage:</label>
                    <input
                        type="text"
                        class="form-control"
                        id="title"
                        [(ngModel)]="poll.title"
                        placeholder="Entrez le titre du questionnaire"
                        name="title"
                        required
                        #title="ngModel"
                    />
                    <small class="text-danger" *ngIf="isPollTitleEmpty()"> Il faut un titre.</small>
                </div>
            </div>
        </form>
        <form class="form-question-container" #questionForm="ngForm" (ngSubmit)="submitQuestion()">
            <div class="question-info-section">
                <div class="form-group question-text">
                    <label class="form-label" for="question-text-id">Question</label>
                    <input
                        class="form-control"
                        id="question-text-id"
                        type="text"
                        [(ngModel)]="currentQuestion.text"
                        placeholder="Entrez votre question."
                        name="text"
                        #text="ngModel"
                        required
                    />
                    <small class="text-danger" *ngIf="isQuestionTextValid()">Entrez votre question</small>
                </div>
            </div>
        
            <div class="form-group answers-section" *ngIf="questionType === 'QCM'">
                <label class="form-label">Réponses:</label>
                <div cdkDropList class="answers-list" (cdkDropListDropped)="drop($event)">
                    <div *ngFor="let choice of currentQuestion.choices; let i = index" class="mb-2 question-choice" cdkDrag>
                        <div class="input-group">
                            <p>{{ i + 1 }}.</p>
                            <input
                                type="text"
                                class="form-control"
                                [(ngModel)]="choice.text"
                                placeholder="Entrez le contenu de la réponse"
                                name="answer{{ choice.text }}"
                                required
                                #answer="ngModel"
                            />
                            <div class="button-section">
                                <button
                                    class="btn btn-sm"
                                    [class.btn-success]="choice.isCorrect"
                                    [class.btn-danger]="!choice.isCorrect"
                                    type="button"
                                    (click)="toggleAnswer(choice)"
                                    [matTooltip]="choice.isCorrect ? 'Marquer comme faux' : 'Marquer comme vrai'"
                                    matTooltipClass="tooltip-custom-class"
                                >
                                    <i class="fas" [ngClass]="{ 'fa-check': choice.isCorrect, 'fa-circle-xmark': !choice.isCorrect }"></i>
                                </button>
                                <button
                                    class="btn btn-dark btn-sm"
                                    type="button"
                                    *ngIf="currentQuestion.choices && currentQuestion.choices.length > 2"
                                    (click)="deleteAnswer(i)"
                                    matTooltip="Supprimer"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                        </div>
                        <small class="form-text text-danger" *ngIf="answer.invalid && (answer.dirty || answer.touched)"> La réponse est requise </small>
                        <div class="upload-section">
                            <input type="file" (change)="onFileSelectedAndUpload($event, choice)" accept="image/*" #fileInput style="display: none" />
                            <button (click)="fileInput.click(); $event.stopPropagation(); $event.preventDefault();" class="upload-btn">
                                Téléverser une image pour cette réponse
                            </button>
                            <button (click)="deleteImage(choice); $event.stopPropagation(); $event.preventDefault();" class="upload-btn">
                                Supprimer l'image de cette réponse
                            </button>
                            <div *ngIf="choice.image">
                                <p>Image téléversée :</p>
                                <img [src]="choice.image" alt="Image associée" style="max-width: 100%; height: auto" />
                            </div>
                        </div>
                    </div>
                </div>
        
                <button class="btn btn-secondary btn-sm" type="button" *ngIf="currentQuestion.choices && currentQuestion.choices.length < 4" (click)="addAnswer()">
                    <i matTooltip="Ajouter un choix de réponse" class="fa-solid fa-plus"></i>
                </button>
        
                <div *ngIf="!hasAtLeastOneTrueAndFalseChoice()" class="text-danger">*Au moins un choix devrait être faux et un vrai.</div>
                <div *ngIf="!validUniqueChoiceTexts()" class="text-danger">*Les choix de réponse doivent être uniques</div>
                <div *ngIf="!questionForm.valid || !areQuestionChoicesTextValid()" class="text-danger">*Tous les champs sont requis.</div>
            </div>
            <div class="submit-section">
                <button *ngIf="showButton" type="button" class="btn btn-dark custom-width" (click)="resetAnswers()">Tout effacer</button>
                <button *ngIf="showButton" type="submit" class="btn custom-button custom-width" [disabled]="!questionForm.valid || !validQuestion()">
                    {{ submitButton }}
                </button>
            </div>
        </form>
        
    </div>
    <div class="created-question-container" @gameFormAnimation>
        <h2>Questions</h2>
        <ul class="question-list-container" cdkDropList (cdkDropListDropped)="onDrop($event)">
            <li
                *ngFor="let question of poll.questions; trackBy: trackByFn; let i = index"
                @zoomIn
                @bounceOut
                class="question-item"
                cdkDrag
                cdkDragPreviewClass="drag-preview"
            >
                <div class="question-title truncate-text">{{ i + 1 }}. {{ question.text }}</div>
                <span class="action-icons">
                    <i class="fas fa-pencil-alt" (click)="editQuestion(i)" matTooltip="Modifier"></i>
                    <i class="fas fa-trash-alt" (click)="deleteQuestion(i)" matTooltip="Supprimer"></i>
                </span>
            </li>
        </ul>
        <div *ngIf="poll.questions.length > 0" class="btn btn-dark add-question-icon">
            <i class="fas fa-plus-circle" (click)="addQuestion()"></i>
        </div>
    </div>
</div>
<div class="submit-game-section">
    <button (click)="emptyPollAndRedirect()" class="btn btn-danger custom-width">Annuler</button>
    <button class="btn btn-primary custom-width" [disabled]="!gameForm.valid || !validatePoll()" (click)="submitPollEvent()">
        {{ submitpollButton }}
    </button>
</div>